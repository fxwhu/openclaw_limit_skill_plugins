要限制 OpenClaw skill 的安装并实现流程审批，可以从几个层面进行控制和集成：

**1. 配置层面限制 Skill 的启用和安装**

OpenClaw 提供了多种配置选项来控制 skill 的可用性：

* **全局或按 Agent 禁用 Skill：** 可以在配置文件 ([`openclaw.json`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/README.md?plain=1#L314)) 中设置 `skills.entries.<skillKey>.enabled: false` 来禁用特定 skill。此外，可以通过 `agents.list.<agentId>.skills` 字段为特定 Agent 设置允许使用的 skill 列表，如果该列表为空，则表示该 Agent 无法使用任何 skill，如果省略则表示所有 skills 均可使用。[`resolveAgentSkillsFilter`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/agent-scope.ts#L128) 函数 ([`src/agents/agent-scope.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/agent-scope.ts)) 用于解析 Agent 配置中指定的 skills 过滤规则。
* **沙盒工具策略 (Sandbox Tool Policy)：** 如果 Agent 运行在沙盒环境中，可以通过配置 [`tools.sandbox.tools.allow`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/commands/sandbox-explain.ts#L223) 和 [`tools.sandbox.tools.deny`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/commands/sandbox-explain.ts#L224) 来严格控制沙盒内可用的工具。Agent 特定的沙盒工具策略（通过 `agents.list.<agentId>.tools.sandbox.tools` 配置）会覆盖全局设置，但最终的工具列表是两者中最严格的交集。即使沙盒允许某个工具，如果 Agent 策略不允许，该工具仍然被禁用。相关逻辑在 [`src/agents/pi-tools.policy.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.policy.ts) 和 [`src/agents/pi-tools.create-openclaw-coding-tools.adds-claude-style-aliases-schemas-without-dropping.test.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.create-openclaw-coding-tools.adds-claude-style-aliases-schemas-without-dropping.test.ts) 中有体现。[`resolveEffectiveToolPolicy`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.policy.ts#L230) 和 [`filterToolsByPolicy`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.policy.ts#L115) 函数在 [`src/agents/pi-tools.policy.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.policy.ts) 中负责解析和应用这些策略。
* **允许的 Bundled Skills 列表：** 对于 OpenClaw 捆绑的 skills，可以通过 [`skills.allowBundled`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/docs/tools/skills.md?plain=1#L186) 配置一个允许列表，只有在该列表中的捆绑 skills 才能被加载。[`isBundledSkillAllowed`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills/config.ts#L88) 函数 ([`src/agents/skills/config.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills/config.ts)) 会检查 skill 是否在允许列表中。
* **Skill 状态检查：** [`buildWorkspaceSkillStatus`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-status.ts#L290) 函数 ([`src/agents/skills-status.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-status.ts)) 可以生成一份所有 skills 的状态报告，包括它们是否符合启用条件、是否被禁用或被允许列表阻止。

**2. 审批流程集成**

OpenClaw 提供了 [`exec.approval.request`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/docs/cli/nodes.md?plain=1#L60) 和 [`exec.approval.resolve`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/ui/src/ui/app.ts#L504) 这类执行审批相关的方法，可以用于集成到外部审批系统中，如 [Agent Command Execution](https://codewiki.google/github.com/openclaw/openclaw#core-agent-development-and-workflow-agent-command-execution) 中所述。

要实现通过流程审批来限制 skill 的安装，可以考虑以下几种集成方式：

* **预安装审批：**
  * **拦截安装命令：** 在执行 [`installSkill`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L396) ([`src/agents/skills-install.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts)) 之前，可以引入一个检查机制。当用户尝试安装一个新的 skill 时，系统不是直接执行安装，而是发送一个审批请求。
  * **Gateway 拦截：** 如果安装操作是通过 Gateway ([`src/gateway/server-methods.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/gateway/server-methods.ts)) 进行的，可以修改 Gateway 的 [`skills.install`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/docs/tools/skills.md?plain=1#L179) 方法来触发审批流程。在 [`handleGatewayRequest`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/gateway/server-methods.ts#L190) 中，[`skills.install`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/docs/tools/skills.md?plain=1#L179) 方法被列为需要 [`operator.admin`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/gateway/call.ts#L263) 权限，但可以在此基础上增加自定义审批逻辑。
  * **外部审批系统集成：** 将审批请求发送给一个外部工作流系统（如 Jira、自建审批平台等）。请求中包含 skill 的名称、安装方式、发起人等信息。
  * **审批结果回调：** 外部系统处理审批后，通过 API 或其他方式通知 OpenClaw。如果审批通过，则继续执行 [`installSkill`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L396)；如果拒绝，则取消安装并通知用户。
* **后安装激活审批 (或后加载审批)：**
  * **默认禁用新安装的 Skill：** 即使一个 skill 被安装到文件系统，也可以在 [`openclaw.json`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/README.md?plain=1#L314) 配置中将其 [`enabled`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/tts/tts.ts#L222) 字段设置为 [`false`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/tui/tui.ts#L100)。
  * **Agent 加载时检查：** 当 Agent 尝试加载 skill 时 ([`buildWorkspaceSkillsPrompt`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills/workspace.ts#L228) 或 [`buildWorkspaceSkillSnapshot`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills/workspace.ts#L191) 在 [`src/agents/skills/workspace.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills/workspace.ts) 中会过滤 [`eligible`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/hooks/loader.ts#L52) 的 skills)，如果该 skill 处于禁用状态，Agent 将不会使用它。
  * **审批后启用：** 审批流程通过后，通过 API 或直接修改 [`openclaw.json`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/README.md?plain=1#L314) 文件，将 `skills.entries.<skillKey>.enabled` 设置为 [`true`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/tts/tts.ts#L222)，从而激活该 skill。
* **结合 Code Review 和安全扫描：**
  * 在 skill 安装之前，执行代码安全扫描，例如 [`scanDirectoryWithSummary`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/plugins/install.ts#L13) ([`src/security/skill-scanner.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/security/skill-scanner.ts))，以识别潜在的危险代码模式。[`collectSkillInstallScanWarnings`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L104) 函数 ([`src/agents/skills-install.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts)) 已经实现了这一部分。
  * 审批流程中应包含对这些扫描结果的审查，甚至可能要求人工对 skill 的 [`SKILL.md`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/README.md?plain=1#L310) 文件（其中包含安装说明和元数据）进行审查。
  * [`buildSkillStatus`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-status.ts#L167) 函数 ([`src/agents/skills-status.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-status.ts)) 报告了 [`blockedByAllowlist`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-status.ts#L178) 和 [`disabled`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/memory/manager.ts#L2187) 状态，这些都可以作为审批流程的触发器或条件。

**实施建议：**

1. **修改 [`installSkill`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L396) 函数或其调用方：** 在 [`installSkill`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L396) ([`src/agents/skills-install.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts)) 内部或在 CLI 命令 ([`registerSkillsCli`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/cli/skills-cli.ts#L342) 在 [`src/cli/skills-cli.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/cli/skills-cli.ts)) 中调用 [`installSkill`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L396) 之前，添加审批逻辑。
2. **使用 Gateway [`exec.approval`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/ui/src/ui/app.ts#L504) 机制：** Gateway 已经提供了 [`exec.approval.request`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/docs/cli/nodes.md?plain=1#L60) 和 [`exec.approval.resolve`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/ui/src/ui/app.ts#L504) 方法，可以在 Gateway 服务器中拦截 [`skills.install`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/docs/tools/skills.md?plain=1#L179) 请求，将其转换为 [`exec.approval.request`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/docs/cli/nodes.md?plain=1#L60)，等待外部审批后，再通过 [`exec.approval.resolve`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/ui/src/ui/app.ts#L504) 回调来执行实际的安装逻辑。
3. **配置更新和通知：** 审批通过后，更新 [`openclaw.json`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/README.md?plain=1#L314) 文件以启用该 skill。可以使用 [`writeConfigFile`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/config/io.ts#L611) (`/openclaw/openclaw/src/config/config.js`) 来实现。
4. **用户界面或 CLI 反馈：** 在安装过程中，提供清晰的用户反馈，说明 skill 正在等待审批。

通过上述方法，可以有效地将流程审批集成到 OpenClaw skill 的安装和管理流程中，提高系统的安全性和可控性。



通过插件的形式实现

是的，可以通过安装插件的方式实现上述流程，OpenClaw 提供了插件架构来扩展其功能，包括：

1. **命令行命令插件** ：你可以创建一个插件来注册新的 CLI 命令，例如用于触发审批流程的命令。[`handlePluginCommand`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/auto-reply/reply/commands-plugin.ts#L16) (在 [`src/auto-reply/reply/commands-plugin.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/auto-reply/reply/commands-plugin.ts) 中定义) 负责处理插件注册的命令。插件命令的匹配和执行通过 [`matchPluginCommand`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/plugins/commands.ts#L167) 和 [`executePluginCommand`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/plugins/commands.ts#L227) 函数完成 (在 [`src/auto-reply/reply/commands-plugin.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/auto-reply/reply/commands-plugin.ts) 中引用)。[`listPluginCommands`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/plugins/commands.ts#L281) (在 [`src/auto-reply/status.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/auto-reply/status.ts) 中引用) 用于列出所有插件提供的命令。
2. **钩子 (Hooks)** ：OpenClaw 支持钩子机制，可以在特定事件发生时执行自定义逻辑。[`runBeforeToolCallHook`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.before-tool-call.ts#L19) (在 [`src/agents/pi-tools.before-tool-call.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.before-tool-call.ts) 中定义) 允许在工具调用之前插入自定义逻辑，这可以用来在 [`installSkill`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L396) 等操作执行前进行审批检查。

* 通过 [`wrapToolWithBeforeToolCallHook`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.before-tool-call.ts#L67) (在 [`src/agents/pi-tools.before-tool-call.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.before-tool-call.ts) 中定义) 函数，可以包装任何 Agent 工具，使其在执行前触发 [`before_tool_call`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/appcast.xml#L150) 钩子。
* 例如，在 [`src/agents/pi-tools.before-tool-call.test.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.before-tool-call.test.ts) 中的测试用例就展示了如何使用 [`before_tool_call`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/appcast.xml#L150) 钩子来修改工具参数或阻止工具执行。

 **实现审批流程的插件方案** ：

* **创建自定义命令插件** ：你可以创建一个插件，定义一个类似 `/request_skill_install` 的命令。当用户执行此命令时，插件可以：
* 接收要安装的 [`skill`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/cli/skills-cli.ts#L155) 名称和 [`installId`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/commands/onboard-skills.ts#L147)。
* 调用 [`skills-install`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/vitest.config.ts#L62) 模块中的 [`collectSkillInstallScanWarnings`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L104) (在 [`src/agents/skills-install.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts) 中定义) 来执行代码安全扫描，并将扫描结果作为审批请求的一部分。
* 将这些信息通过 Gateway 的 [`exec.approval.request`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/docs/cli/nodes.md?plain=1#L60) 机制 (在 [Agent Command Execution](https://codewiki.google/github.com/openclaw/openclaw#core-agent-development-and-workflow-agent-command-execution) 和 [Daemon Service Management](https://codewiki.google/github.com/openclaw/openclaw#core-agent-development-and-workflow-daemon-service-management) 中提及) 发送给外部审批系统。
* 等待审批结果。
* **创建 [`before_tool_call`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/appcast.xml#L150) 钩子插件** ：
* 在插件中实现 [`before_tool_call`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/appcast.xml#L150) 钩子。
* 当 Agent 尝试调用 [`installSkill`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L396) 工具（如果其被封装为工具）时，该钩子会被触发。
* 钩子可以检查当前操作是否是 skill 安装，并根据审批系统的状态（例如，通过 API 调用审批系统查询），决定是允许安装、修改安装参数还是阻止安装。
* 如果审批未通过，钩子可以设置 [`block: true`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/tts/tts.ts#L222) 并提供 [`blockReason`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/plugins/types.ts#L393)，从而阻止 [`installSkill`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/skills-install.ts#L396) 的执行，如 [`src/agents/pi-tools.before-tool-call.test.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/agents/pi-tools.before-tool-call.test.ts) 的测试用例所示。
* **配置管理** ：审批通过后，可以通过插件编程方式修改 OpenClaw 配置 ([`openclaw.json`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/README.md?plain=1#L314))，例如将 `skills.entries.<skillKey>.enabled` 设置为 [`true`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/tts/tts.ts#L222)，以激活已批准安装的 skill。[`writeConfigFile`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/config/io.ts#L611) (在 [`src/cli/config-cli.ts`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/src/cli/config-cli.ts) 中引用) 函数可用于写入配置文件。

通过结合自定义命令插件和 [`before_tool_call`](https://github.com/openclaw/openclaw/blob/e3d3893d5dbec30c2046166b6a71bacfe641ef78/appcast.xml#L150) 钩子插件，可以构建一个完善的 skill 安装审批流程。
